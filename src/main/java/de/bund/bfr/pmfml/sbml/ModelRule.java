/***************************************************************************************************
 * Copyright (c) 2015 Federal Institute for Risk Assessment (BfR), Germany
 *
 * This program is free software: you can redistribute it and/or modify it under the terms of the
 * GNU General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
 * even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program. If
 * not, see <http://www.gnu.org/licenses/>.
 *
 * Contributors: Department Biological Safety - BfR
 **************************************************************************************************/
package de.bund.bfr.pmfml.sbml;

import de.bund.bfr.pmfml.ModelClass;
import org.sbml.jsbml.ASTNode;
import org.sbml.jsbml.Annotation;
import org.sbml.jsbml.AssignmentRule;
import org.sbml.jsbml.JSBML;
import org.sbml.jsbml.text.parser.ParseException;
import org.sbml.jsbml.xml.XMLNode;
import org.sbml.jsbml.xml.XMLTriple;

import java.util.List;


/**
 * Model rule. It has the properties:
 * <ul>
 * <li>Formula (mandatory)</li>
 * <li>Variable (mandatory)</li>
 * <li>Formula name (mandatory)</li>
 * <li>Model class (mandatory)</li>
 * <li>PmmLab id (mandatory)</li>
 * <li>References (optional)</li>
 * </ul>
 * 
 * @author Miguel Alba
 */
public class ModelRule {

  private AssignmentRule rule;
  private String formulaName;
  private ModelClass modelClass;
  private int pmmlabID;
  private Reference[] references;

  public ModelRule(final String variable, final String formula, final String formulaName,
      final ModelClass modelClass, final int pmmlabID, final Reference[] references) {
    this.formulaName = formulaName;
    this.modelClass = modelClass;
    this.pmmlabID = pmmlabID;
    this.references = references;

    ASTNode math = null;
    try {
      math = JSBML.parseFormula(formula);
    } catch (ParseException e) {
      // TODO Auto-generated catch block
      e.printStackTrace();
    }
    rule = new AssignmentRule(math, 3, 1);
    rule.setVariable(variable);
    final ModelRuleAnnotation annot =
        new ModelRuleAnnotation(formulaName, modelClass, pmmlabID, references);
    rule.setAnnotation(annot.annotation);
  }

  public ModelRule(AssignmentRule rule) {
    this.rule = rule;
    if (rule.isSetAnnotation()) {
      final ModelRuleAnnotation annot = new ModelRuleAnnotation(rule.getAnnotation());
      pmmlabID = annot.pmmlabID;
      formulaName = annot.formulaName;
      modelClass = annot.modelClass;
      references = annot.references;
    }
  }

  public AssignmentRule getRule() {
    return rule;
  }

  /** Returns the formula of this {@link ModelRule}. */
  public String getFormula() {
    return rule.getMath().toFormula();
  }

  /** Returns the variable of this {@link ModelRule}. */
  public String getVariable() {
    return rule.getVariable();
  }

  /** Returns the formula name of this {@link ModelRule}. */
  public String getFormulaName() {
    return formulaName;
  }

  /** Returns the {@link ModelClass} of this {@link ModelRule}. */
  public ModelClass getModelClass() {
    return modelClass;
  }

  /** Returns the PmmLab id of this {@link ModelRule}. */
  public int getPmmlabID() {
    return pmmlabID;
  }

  /** Returns the {@link Reference}(s) of this {@link ModelRule}. If not set, returns null. */
  public Reference[] getReferences() {
    return references;
  }

  /**
   * Sets the formula name value of this {@link ModelRule} with 'formulaName'. Ignores null or empty
   * strings.
   */
  public void setFormulaName(final String formulaName) {
    this.formulaName = formulaName;
  }

  /**
   * Sets the {@link ModelClass} value of this {@link ModelRule} with 'modelClass'. Ignores null.
   */
  public void setModelClass(final ModelClass modelClass) {
    this.modelClass = modelClass;
  }

  /** Sets the PmmLab id value of this {@link ModelRule} with 'id'. */
  public void setPmmlabID(final int id) {
    this.pmmlabID = id;
  }

  /** Sets the references of this {@link ModelRule} with 'references'. Ignores null. */
  public void setReferences(final Reference[] references) {
    this.references = references;
  }

  /** Returns true if the references of this {@link ModelRule} are set. */
  public boolean isSetReferences() {
    return references == null;
  }
}


class ModelRuleAnnotation {

  String formulaName;
  ModelClass modelClass;
  Reference[] references;
  int pmmlabID;
  Annotation annotation;

  private static final String FORMULA_TAG = "formulaName";
  private static final String SUBJECT_TAG = "subject";
  private static final String REFERENCE_TAG = "reference";
  private static final String PMMLAB_ID = "pmmlabID";

  public ModelRuleAnnotation(final Annotation annotation) {
    this.annotation = annotation;

    final XMLNode metadata = annotation.getNonRDFannotation().getChildElement("metadata", "");

    // Gets formula name
    final XMLNode nameNode = metadata.getChildElement(FORMULA_TAG, "");
    formulaName = nameNode.getChild(0).getCharacters();

    // Gets formula subject
    final XMLNode modelclassNode = metadata.getChildElement(SUBJECT_TAG, "");
    if (modelclassNode == null) {
      modelClass = ModelClass.UNKNOWN;
    } else {
      modelClass = ModelClass.fromName(modelclassNode.getChild(0).getCharacters());
    }

    // Get PmmLab ID
    final XMLNode idNode = metadata.getChildElement(PMMLAB_ID, "");
    if (idNode == null) {
      pmmlabID = -1;
    } else {
      pmmlabID = Integer.parseInt(idNode.getChild(0).getCharacters());
    }

    // Gets references
    final List<XMLNode> refNodes = metadata.getChildElements(REFERENCE_TAG, "");
    final int numRefNodes = refNodes.size();
    references = new ReferenceImpl[numRefNodes];
    for (int i = 0; i < numRefNodes; i++) {
      references[i] = new ReferenceSBMLNode(refNodes.get(i)).toReference();
    }
  }

  public ModelRuleAnnotation(final String formulaName, final ModelClass modelClass, final int pmmlabID,
      final Reference[] references) {

    // Builds metadata node
    final XMLNode metadataNode = new XMLNode(new XMLTriple("metadata", null, "pmf"));
    annotation = new Annotation();
    annotation.setNonRDFAnnotation(metadataNode);

    // Creates annotation for formula name
    final XMLNode nameNode = new XMLNode(new XMLTriple(FORMULA_TAG, null, "pmmlab"));
    nameNode.addChild(new XMLNode(formulaName));
    metadataNode.addChild(nameNode);

    // Creates annotation for modelClass
    final XMLNode modelClassNode = new XMLNode(new XMLTriple(SUBJECT_TAG, null, "pmmlab"));
    modelClassNode.addChild(new XMLNode(modelClass.fullName()));
    metadataNode.addChild(modelClassNode);

    // Create annotation for pmmlabID
    final XMLNode idNode = new XMLNode(new XMLTriple(PMMLAB_ID, null, "pmmlab"));
    idNode.addChild(new XMLNode(Integer.toString(pmmlabID)));
    metadataNode.addChild(idNode);

    // Builds reference nodes
    for (final Reference ref : references) {
      metadataNode.addChild(new ReferenceSBMLNode(ref).node);
    }

    // Saves formulaName, subject and model literature
    this.formulaName = formulaName;
    this.modelClass = modelClass;
    this.pmmlabID = pmmlabID;
    this.references = references;
  }
}
